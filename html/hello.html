<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Day Trader</title>

    <link rel="icon" href="https://www.kindpng.com/picc/m/12-129720_red-arrow-line-png-red-hand-drawn-arrow.png">
    <!--Contains all the CSS-->
    <style>
      .graph-row {
        display: inline-block;
        text-align: center;
        width: 100%; 
        margin:0 auto; 
      }

      /* Used for drawing the companies stock graph */
      .graph-child {
        width: 400px;
        height: 400px;
        padding: 0px;
        display:inline-block;
        background-color: black; 
        border-radius:15px; 
        border: 5px solid #333333;
      }

      .stock_graph {
        width: 400px;
        height: 342px;
        border-radius:10px; 
      }

      .buy_button {
        width:80px;
        height:50px;
        font-size: 30px;
        color:black;
        background-color: rgb(0, 200, 0);
        border-radius: 10px;
        float:left;
      }

      .buy_button:hover {
        background-color: rgb(35, 255, 35);;
      }

      .sell_button {
        width:80px;
        height:50px;
        font-size: 30px; 
        color:black;
        background-color: rgb(200, 0, 0);
        border-radius: 10px;
        float:left;
      }

      .sell_button:hover {
        background-color: rgb(255, 50, 50);
      }

      .stock_amount_display {
        width: 80px;
        height: 50px;
        color: black;
        background-color: white;
        border-radius: 10px;
        float:left;
        /* Centered Text */
        font-size: 20px; 
        text-align: center;
      }

      .money_button {
        width:200px;
        height:50px;
        font-size: 30px; 
        color:black;
        background-color: rgb(255, 255, 255);
        border-radius: 10px;
        float:center;
      }
      
    </style>
  </head>
  
  <body style = "font: 30px Helvetica; background-color: #555555; min-width: 900px;">
    
    <h1>Day Trader</h1>
    <button class="money_button" id="money">100$</button>
    <!--Where the company graphs are-->
    <!--Centers the graphs-->
    <div class="graph-row";>
      <div class="graph-child">
        <canvas id="amazon_canvas"; class="stock_graph"; width="500"; height="440"></canvas>
        <button class="buy_button"; type="button"; onclick="buy_stock('Amazon', 5);">+5</button>
        <button class="buy_button"; type="button"; onclick="buy_stock('Amazon', 1);">+1</button>
        <button class="sell_button"; type="button"; onclick="sell_stock('Amazon', 1);">-1</button>
        <button class="sell_button"; type="button"; onclick="sell_stock('Amazon', 5);">-5</button>
        <button class="stock_amount_display" id="amazon_stock_amount">Loading</button>
      </div>
      <div class="graph-child">
        <canvas id="apple_canvas"; class="stock_graph"; width="500"; height="440"></canvas>
        <button class="buy_button"; type="button"; onclick="buy_stock('Apple', 5);">+5</button>
        <button class="buy_button"; type="button"; onclick="buy_stock('Apple', 1);">+1</button>
        <button class="sell_button"; type="button"; onclick="sell_stock('Apple', 1);">-1</button>
        <button class="sell_button"; type="button"; onclick="sell_stock('Apple', 5);">-5</button>
        <button class="stock_amount_display" id="apple_stock_amount">Loading</button>
      </div>
    </div>

    <!--Global variables-->
    <script>
      //Holds all the companies
      var companies = ["amazon", "apple"];

      //Stores the stocks purchase price
      var stock_purchase_price = new Map();
      stock_purchase_price.set("amazon", 0);
      stock_purchase_price.set("apple", 0);

      //Stores the stock amount
      var stock_amount_map = new Map();
      stock_amount_map.set("amazon", 0);
      stock_amount_map.set("apple", 0);

      //Stores the stock data
      var stock_data_text = "";

      //Stores the pressed keys
      var pressedKeys = {};
      window.onkeyup = function(e) { pressedKeys[e.keyCode] = false; }
      window.onkeydown = function(e) { pressedKeys[e.keyCode] = true; console.log(e.keyCode); }
      /*
        Up    38
        Down  40
        Left  37
        Right 39
      */
    </script>

    <!-- Stock Selling Script-->
    <script>
      //Buys a stock from a company
      // company (String)
      // amount (u_int)
      function buy_stock(company, amount) {
        //Ensures that there is enough stock to sell
        let stock_amount = stock_amount_map.get(company.toLowerCase());

        //Make the request for the text info
        let buy_request = new XMLHttpRequest();
        buy_request.open("POST", "buy_request", false);
        //Send the request
        buy_request.send(amount + ',' + company);

        //Updates the stock display
        if (buy_request.responseText == "Bought") {
          let stock_display = document.getElementById(company.toLowerCase() + '_stock_amount');

          //Updates the stock amount map
          stock_amount_map.set(company.toLowerCase(), stock_amount_map.get(company.toLowerCase()) + amount);
          
          let current_value = parseInt(stock_display.textContent);
          stock_display.textContent = current_value + amount;
          //Updates the amount of cash and stock amount (Since it needs to recalculate the average stock price!)
          update_money_amount();
          update_stock_amount();
        } 
      }

      //Sells a stock from a company
      // company (String)
      // amount (u_int)
      function sell_stock(company, amount) {
        //Ensures that there is enough stock to sell
        let stock_amount = stock_amount_map.get(company.toLowerCase());

        //If there is no stock exit
        if (stock_amount == 0) return;
        
        //If there isn't enough stock, adjust it so we sell the remaining amount
        if (stock_amount < amount) { amount = stock_amount; }

        //Make the request for the text info
        let sell_request = new XMLHttpRequest();
        sell_request.open("POST", "sell_request", false);
        //Send the request
        sell_request.send(amount + ',' + company);

        //Updates the stock display
        if (sell_request.responseText == "Sold") {
          let stock_display = document.getElementById(company.toLowerCase() + '_stock_amount');

          let current_value = parseInt(stock_display.textContent);
          stock_display.textContent = current_value - amount;
          //Updates the amount of cash and stock amount (Since it needs to recalculate the average stock price!)
          update_money_amount();
          update_stock_amount();
        } 
      }

      //Updates the amount of money
      function update_money_amount() {
        //Make the request for the text info
        let money_file = new XMLHttpRequest();

        //Opens the data file, (NOT ASYNC)
        money_file.open("GET", "money", true);

        money_file.onload = function() {
          //Updates the stock display
          if (money_file.responseText != null) {
            let money_display = document.getElementById('money');
            money_display.textContent = parseFloat(money_file.responseText).toFixed(2) + '$';
          } 
        }

        //Send the file
        money_file.send();
      }

      //Updates the stock count
      function update_stock_amount() {
        //Make the request for the text info
        let stock_file = new XMLHttpRequest();

        //Opens the data file
        stock_file.open("GET", "stock_amount", true);
        console.log("Updating stock amount!");
        //On load parse the data
        stock_file.onload = function() {
          parse_stock_amount(stock_file.responseText);
          //Redraws the stock data
          draw_stock_data();
        }

        //Sends the file
        stock_file.send();
      }


      // Parses the stock amount string
      function parse_stock_amount(text) {

        //Splits the text by each ','
        let split_text = text.split('\n');
        
        //For each stock in the text
        for (let i = 0; i < split_text.length; i++) {
          //Gets the stock
          let stock = split_text[i];
          if (!stock) continue;

          //Splits the stock by each '_'
          let split_stock = stock.split('_');
          if (split_stock.length != 3) continue;
          let stock_amount = parseInt(split_stock[0], 10);

          //Gets the Companies name and amount
          let company_name = split_stock[1].toLowerCase();
          let stock_price = parseFloat(split_stock[2], 10);

          //Updates the maps
          stock_amount_map.set(company_name, stock_amount);
          stock_purchase_price.set(company_name, stock_price);
          //Determines the canvas's name
          let display_name = company_name + "_stock_amount";
        }
        
        //Loops through each company
        for (let i = 0; i < companies.length; i++) {
          //Gets the canvas to draw on
          let display = document.getElementById(companies[i] + "_stock_amount");

          //Set the displays value
          display.innerText = stock_amount_map.get(companies[i]);
        }
      }

      //Updates the stock data
      function update_stock_data() {
        //Make the request for the text info
        let stock_data_request = new XMLHttpRequest();
        //Opens the data file, (NOT ASYNC)
        stock_data_request.open("GET", "stock_data", true);

        stock_data_request.onload = function() {
          //Get the text, then draws the data
          stock_data_text = stock_data_request.responseText;
          draw_stock_data();
        }

        //Send the file
        stock_data_request.send();
      }

      //Draws the stock data
      function draw_stock_data() {
        //Won't render if the text is empty
        if(!stock_data_text) return;

        let split_company = stock_data_text.split("\n");

        //For each company
        for (let k = 0; k < split_company.length; k++) {
          let split_text = split_company[k].split(",");

          let company_name = split_text[0];

          //Determines the canvas's name
          let canvas_name = company_name.toLowerCase() + "_canvas";

          //Gets the canvas to draw on
          let canvas = document.getElementById(canvas_name);

          //Render_height is just under the text
          let width = canvas.width;
          let height = canvas.height;
          let render_height = canvas.height - 40;

          //Gets the 2d canvas
          let ctx = canvas.getContext("2d");

          //Clears the canvas
          ctx.clearRect(0, 0, width, height);
          ctx.strokeStyle = "#FFFFFF";
          ctx.lineWidth = 2;

          //The spacing and height for drawing the lines
          let x_spacing = width / (split_text.length - 2);

          //Gets the highest value for that stock
          let max_value = 0.0;
          let starting_value = parseFloat(split_text[1]);
          for (let i = 1; i < split_text.length; i++) {
            let value = parseFloat(split_text[i]);
            if (value > max_value) max_value = value;
          }

          //Defaults at the bottom left of the canvas
          let prev_value = starting_value;
          let value = 0;
          ctx.moveTo(0, height - render_height * parseFloat(starting_value) / max_value);
          ctx.beginPath();

          //For each value, draw the stock graph
          for (let i = 1; i < split_text.length; i++) {
            //Get the current value
            value = parseFloat(split_text[i]);
            //Draws the stock line
            ctx.lineTo(x_spacing * (i-1), height - render_height * parseFloat(value) / max_value);
            //A Smoother line 
            prev_value = value;
          }

          //Draw the stoke line
          ctx.stroke();

          //Setting up the text
          ctx.font = "30px Helvetica";
          ctx.textAlign = "left";

          //Draws the stock price line! and text
          let average_stock_price = stock_purchase_price.get(company_name.toLowerCase());
          if (average_stock_price != 0) {
            ctx.beginPath()
            // The style of the stock price line
            ctx.strokeStyle="#5555FF";
            ctx.lineWidth = 4;
            //Draws the line
            let average_line_height = height - render_height * average_stock_price / max_value;
            //Caps the line at 0
            if (average_line_height < 3) { average_line_height = 3; }
            
            ctx.moveTo(0, average_line_height);
            ctx.lineTo(width, average_line_height);
            ctx.stroke();
            
            //Only draws the square if it doesnt obstruct the company text
            if (average_line_height > 40) {
              //Draws the square around the text
              let average_price_text = average_stock_price.toFixed(2);
              let text_size = ctx.measureText(average_price_text);
              ctx.fillStyle="#444444"
              ctx.roundRect(1, average_line_height, text_size.width + 10, 40, 8).fill();

              //Draws the text
              ctx.fillStyle = "#FFFFFF";
              ctx.fillText(average_price_text, 5, average_line_height + 30);
            }
          }

          ctx.fillStyle = "#444444";
          ctx.strokeStyle = "#000000";
          //Draw the background rect for the text
          let company_text = company_name + " " + value.toFixed(2);
          let text_size = ctx.measureText(company_text);
          ctx.roundRect(1, 1, text_size.width + 10, 40, 8).fill();
          
          //Sets the text back to white
          ctx.fillStyle = "#FFFFFF";
          //Draw the company Text
          ctx.fillText(company_text, 5, 30);
        }
      }
      
    </script>
    
    <script>
      //When finishing the window loading get the stock data every 20s
      window.onload = function WindowLoad(event) {
        //Updates the stock data / stock amount initially
        update_stock_amount();
        update_money_amount();
        update_stock_data();
        
        //Will continue updating the stock data every 10s
        const stock_data_interval = setInterval(() => {
          update_stock_data();
        }, 5000);
      }

      //Allows the drawing of rounded Rects
      CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
        if (w < 2 * r) r = w / 2;
        if (h < 2 * r) r = h / 2;
        this.beginPath();
        this.moveTo(x+r, y);
        this.arcTo(x+w, y,   x+w, y+h, r);
        this.arcTo(x+w, y+h, x,   y+h, r);
        this.arcTo(x,   y+h, x,   y,   r);
        this.arcTo(x,   y,   x+w, y,   r);
        this.closePath();
        return this;
      }
      </script>
  </body>
</html>
